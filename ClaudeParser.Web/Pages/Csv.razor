@page "/csv"
@using ClaudeParser.Examples
@using ClaudeParser.Core

<PageTitle>CSV Parser - ClaudeParser</PageTitle>

<h1>ğŸ“Š CSV Parser</h1>

<p>RFC 4180æº–æ‹ ã®CSVã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¾ã™ã€‚ã‚¯ã‚©ãƒ¼ãƒˆã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã€æ”¹è¡Œã‚’å«ã‚€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚</p>

<div class="row">
    <div class="col-md-6">
        <div class="mb-3">
            <label for="csvInput" class="form-label">CSVå…¥åŠ›</label>
            <textarea class="form-control font-monospace" id="csvInput" rows="8" 
                      @bind="csvInput" @bind:event="oninput" @bind:after="ParseCsv"
                      placeholder="name,age,city&#10;Alice,30,Tokyo"></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label">ã‚ªãƒ—ã‚·ãƒ§ãƒ³</label>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" @bind="hasHeader" @bind:after="ParseCsv" id="hasHeader">
                <label class="form-check-label" for="hasHeader">
                    ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚ã‚Š
                </label>
            </div>
            <div class="mt-2">
                <label for="delimiter" class="form-label">åŒºåˆ‡ã‚Šæ–‡å­—</label>
                <select class="form-select form-select-sm w-auto" id="delimiter" @bind="delimiter" @bind:after="ParseCsv">
                    <option value=",">,ï¼ˆã‚«ãƒ³ãƒï¼‰</option>
                    <option value=";">; ï¼ˆã‚»ãƒŸã‚³ãƒ­ãƒ³ï¼‰</option>
                    <option value="&#9">TAB</option>
                </select>
            </div>
        </div>
        <button class="btn btn-secondary" @onclick="Clear">ã‚¯ãƒªã‚¢</button>
    </div>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="mt-4">
        <div class="alert alert-danger" role="alert">
            <h5>ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼</h5>
            <pre style="white-space: pre-wrap; margin: 0;">@errorMessage</pre>
        </div>
    </div>
}

@if (parsedData != null && parsedData.Count > 0)
{
    <div class="mt-4">
        <h3>ãƒ‘ãƒ¼ã‚¹çµæœ</h3>
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                @if (hasHeader && headers != null)
                {
                    <thead class="table-dark">
                        <tr>
                            @foreach (var header in headers)
                            {
                                <th>@header</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in parsedData.Skip(1))
                        {
                            <tr>
                                @foreach (var cell in row)
                                {
                                    <td>@RenderCell(cell)</td>
                                }
                            </tr>
                        }
                    </tbody>
                }
                else
                {
                    <tbody>
                        @foreach (var row in parsedData)
                        {
                            <tr>
                                @foreach (var cell in row)
                                {
                                    <td>@RenderCell(cell)</td>
                                }
                            </tr>
                        }
                    </tbody>
                }
            </table>
        </div>
        <p class="text-muted">@parsedData.Count è¡Œã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¾ã—ãŸ</p>
    </div>
}

<div class="mt-4">
    <h3>ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿</h3>
    <div class="d-flex flex-wrap gap-2 mb-3">
        @foreach (var (name, _) in samples)
        {
            <button class="btn btn-outline-primary btn-sm" @onclick="() => SetSample(name)">@name</button>
        }
    </div>
</div>

<div class="mt-4">
    <h3>CSVæ§‹æ–‡</h3>
    <ul>
        <li>ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š</li>
        <li>ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆ <code>"</code> ã§å›²ã‚€ã¨ã‚«ãƒ³ãƒã‚„æ”¹è¡Œã‚’å«ã‚ã‚‰ã‚Œã‚‹</li>
        <li>ã‚¯ã‚©ãƒ¼ãƒˆå†…ã®ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã¯ <code>""</code> ã§ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—</li>
    </ul>
</div>

@code {
    private string csvInput = "";
    private bool hasHeader = true;
    private string delimiter = ",";
    private string errorMessage = "";
    private IReadOnlyList<IReadOnlyList<string>>? parsedData;
    private IReadOnlyList<string>? headers;

    private readonly (string name, string data)[] samples = new[]
    {
        ("ã‚·ãƒ³ãƒ—ãƒ«", "name,age,city\nAlice,30,Tokyo\nBob,25,Osaka\nCharlie,35,Kyoto"),
        ("ã‚¯ã‚©ãƒ¼ãƒˆä»˜ã", "name,description,price\n\"iPhone 15\",\"Apple's smartphone, with new features\",999\n\"Galaxy S24\",\"Samsung flagship\",899"),
        ("ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—", "text,value\n\"He said \"\"Hello\"\"\",100\n\"Line1\nLine2\",200"),
        ("ç©ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰", "a,b,c\n1,,3\n,2,\n,,"),
    };

    private void ParseCsv()
    {
        errorMessage = "";
        parsedData = null;
        headers = null;

        if (string.IsNullOrWhiteSpace(csvInput))
        {
            return;  // ç©ºã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã—ãªã„
        }

        try
        {
            char delimChar = delimiter == "\t" ? '\t' : delimiter[0];
            parsedData = CsvParser.Parse(csvInput, delimChar);
            
            if (hasHeader && parsedData.Count > 0)
            {
                headers = parsedData[0];
            }
        }
        catch (ParseException ex)
        {
            errorMessage = ex.Error.ToDetailedString(csvInput);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    private void Clear()
    {
        csvInput = "";
        errorMessage = "";
        parsedData = null;
        headers = null;
    }

    private void SetSample(string name)
    {
        var sample = samples.FirstOrDefault(s => s.name == name);
        if (sample != default)
        {
            csvInput = sample.data;
            ParseCsv();
        }
    }

    private string RenderCell(string cell)
    {
        if (string.IsNullOrEmpty(cell))
            return "(empty)";
        return cell.Replace("\n", "â†µ");
    }
}
